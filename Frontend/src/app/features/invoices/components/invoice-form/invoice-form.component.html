<div class="invoice-form-container">
  <h2 mat-dialog-title>
    {{ mode === 'create' ? 'Create' : mode === 'edit' ? 'Edit' : 'View' }} 
    {{ type === 'sales' ? 'Sales' : 'Purchase' }} Invoice
  </h2>

  <mat-dialog-content>
    <div class="loading-overlay" *ngIf="loading">
      <mat-spinner diameter="40"></mat-spinner>
    </div>

    <form [formGroup]="invoiceForm" class="invoice-form">
      <div class="form-row">
        <mat-form-field *ngIf="type === 'sales'" class="full-width">
          <mat-label>Customer</mat-label>
          <mat-select formControlName="customerId" [disabled]="mode === 'view'">
            <mat-option *ngFor="let customer of customers" [value]="customer._id">
              {{ customer.code }} - {{ customer.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="invoiceForm.get('customerId')?.hasError('required')">
            Customer is required
          </mat-error>
        </mat-form-field>

        <mat-form-field *ngIf="type === 'purchase'" class="full-width">
          <mat-label>Supplier</mat-label>
          <mat-select formControlName="supplierId" [disabled]="mode === 'view'">
            <mat-option *ngFor="let supplier of suppliers" [value]="supplier._id">
              {{ supplier.code }} - {{ supplier.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="invoiceForm.get('supplierId')?.hasError('required')">
            Supplier is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row two-columns">
        <mat-form-field>
          <mat-label>Invoice Date</mat-label>
          <input matInput [matDatepicker]="invoiceDatePicker" formControlName="invoiceDate" [disabled]="mode === 'view'">
          <mat-datepicker-toggle matIconSuffix [for]="invoiceDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #invoiceDatePicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Due Date</mat-label>
          <input matInput [matDatepicker]="dueDatePicker" formControlName="dueDate" [disabled]="mode === 'view'">
          <mat-datepicker-toggle matIconSuffix [for]="dueDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #dueDatePicker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="form-row" *ngIf="type === 'purchase'">
        <mat-form-field class="full-width">
          <mat-label>Supplier Bill No</mat-label>
          <input matInput formControlName="supplierBillNo" [readonly]="mode === 'view'">
        </mat-form-field>
      </div>

      <div class="items-section">
        <div class="items-header">
          <h3>Invoice Items</h3>
          <button mat-raised-button color="primary" type="button" (click)="addItem()" 
                  *ngIf="mode !== 'view'" [disabled]="loading">
            <mat-icon>add</mat-icon> Add Item
          </button>
        </div>

        <div class="items-table-container" *ngIf="itemsArray.length > 0">
          <table mat-table [dataSource]="itemsArray.controls" class="items-table">
            <ng-container matColumnDef="item">
              <th mat-header-cell *matHeaderCellDef>Item</th>
              <td mat-cell *matCellDef="let item; let i = index">
                <mat-form-field class="item-field" [formGroup]="item">
                  <mat-label>Select Item</mat-label>
                  <input type="text" matInput
                         [matAutocomplete]="autoItem"
                         (input)="onItemSearch($event)"
                         [value]="item.get('itemName')?.value"
                         [readonly]="mode === 'view'">
                  <mat-autocomplete #autoItem="matAutocomplete" 
                                    [displayWith]="displayItem"
                                    (optionSelected)="onItemSelected($event, i)">
                    <mat-option *ngFor="let opt of filteredItems" [value]="opt">
                      {{ opt.code }} - {{ opt.name }}
                    </mat-option>
                  </mat-autocomplete>
                </mat-form-field>
              </td>
            </ng-container>

            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Qty</th>
              <td mat-cell *matCellDef="let item; let i = index" [formGroup]="item">
                <mat-form-field class="qty-field">
                  <input matInput type="number" formControlName="quantity" 
                         (change)="calculateLineTotal(i)" [readonly]="mode === 'view'">
                </mat-form-field>
              </td>
            </ng-container>

            <ng-container matColumnDef="rate">
              <th mat-header-cell *matHeaderCellDef>Rate</th>
              <td mat-cell *matCellDef="let item; let i = index" [formGroup]="item">
                <mat-form-field class="rate-field">
                  <input matInput type="number" formControlName="unitPrice" 
                         (change)="calculateLineTotal(i)" [readonly]="mode === 'view'">
                </mat-form-field>
              </td>
            </ng-container>

            <ng-container matColumnDef="discount">
              <th mat-header-cell *matHeaderCellDef>Disc %</th>
              <td mat-cell *matCellDef="let item; let i = index" [formGroup]="item">
                <mat-form-field class="disc-field">
                  <input matInput type="number" formControlName="discount" 
                         (change)="calculateLineTotal(i)" [readonly]="mode === 'view'">
                </mat-form-field>
              </td>
            </ng-container>

            <ng-container matColumnDef="tax">
              <th mat-header-cell *matHeaderCellDef>Tax</th>
              <td mat-cell *matCellDef="let item" [formGroup]="item">
                {{ formatCurrency(item.get('taxAmount')?.value) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="total">
              <th mat-header-cell *matHeaderCellDef>Total</th>
              <td mat-cell *matCellDef="let item" [formGroup]="item">
                <strong>{{ formatCurrency(item.get('lineTotal')?.value) }}</strong>
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let item; let i = index">
                <button mat-icon-button color="warn" (click)="removeItem(i)" 
                        *ngIf="mode !== 'view'" matTooltip="Remove item">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>

        <div class="no-items" *ngIf="itemsArray.length === 0">
          <mat-icon>inventory_2</mat-icon>
          <p>No items added yet. Click "Add Item" to begin.</p>
        </div>
      </div>

      <div class="totals-section">
        <div class="totals-grid">
          <div class="total-row">
            <span>Subtotal:</span>
            <span>{{ formatCurrency(calculateTotals().subtotal) }}</span>
          </div>
          <div class="total-row">
            <span>Discount:</span>
            <span class="discount">-{{ formatCurrency(calculateTotals().totalDiscount) }}</span>
          </div>
          <div class="total-row">
            <span>Tax:</span>
            <span>{{ formatCurrency(calculateTotals().totalTax) }}</span>
          </div>
          <div class="total-row grand-total">
            <span>Grand Total:</span>
            <span>{{ formatCurrency(calculateTotals().grandTotal) }}</span>
          </div>
        </div>
      </div>

      <div class="form-row">
        <mat-form-field class="full-width">
          <mat-label>Notes</mat-label>
          <textarea matInput formControlName="notes" rows="3" [readonly]="mode === 'view'"></textarea>
        </mat-form-field>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="cancel()">
      {{ mode === 'view' ? 'Close' : 'Cancel' }}
    </button>
    <button mat-raised-button color="primary" (click)="save()" 
            *ngIf="mode !== 'view'" [disabled]="saving || loading">
      <mat-spinner diameter="20" *ngIf="saving"></mat-spinner>
      <span *ngIf="!saving">{{ mode === 'create' ? 'Create Invoice' : 'Update Invoice' }}</span>
    </button>
  </mat-dialog-actions>
</div>
