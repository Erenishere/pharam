<div class="purchase-invoice-container">
  <div class="page-header">
    <div class="header-left">
      <h1>Purchase Invoices</h1>
      <p class="subtitle">Manage supplier invoices and goods receipt</p>
    </div>
    <button mat-raised-button color="primary" (click)="createInvoice()">
      <mat-icon>add</mat-icon> New Purchase Invoice
    </button>
  </div>

  <div class="statistics-cards" *ngIf="statistics">
    <div class="stat-card">
      <mat-icon>receipt_long</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ statistics.totalInvoices }}</span>
        <span class="stat-label">Total Invoices</span>
      </div>
    </div>
    <div class="stat-card">
      <mat-icon>account_balance_wallet</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ formatCurrency(statistics.totalAmount) }}</span>
        <span class="stat-label">Total Amount</span>
      </div>
    </div>
    <div class="stat-card pending">
      <mat-icon>pending</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ formatCurrency(statistics.pendingAmount) }}</span>
        <span class="stat-label">Pending Payment</span>
      </div>
    </div>
    <div class="stat-card paid">
      <mat-icon>check_circle</mat-icon>
      <div class="stat-content">
        <span class="stat-value">{{ formatCurrency(statistics.paidAmount) }}</span>
        <span class="stat-label">Paid Amount</span>
      </div>
    </div>
  </div>

  <div class="filters-section">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search invoices</mat-label>
      <input matInput [formControl]="searchControl">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Status</mat-label>
      <mat-select [(value)]="selectedStatus" (selectionChange)="onFilterChange()">
        <mat-option *ngFor="let opt of statusOptions" [value]="opt.value">{{ opt.label }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Payment Status</mat-label>
      <mat-select [(value)]="selectedPaymentStatus" (selectionChange)="onFilterChange()">
        <mat-option *ngFor="let opt of paymentStatusOptions" [value]="opt.value">{{ opt.label }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>From Date</mat-label>
      <input matInput [matDatepicker]="fromPicker" [(ngModel)]="dateFrom" (dateChange)="onFilterChange()">
      <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
      <mat-datepicker #fromPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>To Date</mat-label>
      <input matInput [matDatepicker]="toPicker" [(ngModel)]="dateTo" (dateChange)="onFilterChange()">
      <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
      <mat-datepicker #toPicker></mat-datepicker>
    </mat-form-field>

    <button mat-stroked-button color="warn" (click)="clearFilters()"
      *ngIf="searchControl.value || selectedStatus || selectedPaymentStatus || dateFrom || dateTo">
      <mat-icon>clear</mat-icon> Clear Filters
    </button>
  </div>

  <div class="table-container">
    <div class="loading-overlay" *ngIf="loading">
      <mat-spinner diameter="40"></mat-spinner>
    </div>

    <div class="error-message" *ngIf="error && !loading">
      <mat-icon>error</mat-icon>
      <span>{{ error }}</span>
      <button mat-button color="primary" (click)="loadInvoices()">Retry</button>
    </div>

    <table mat-table [dataSource]="dataSource" matSort *ngIf="!error">
      <ng-container matColumnDef="invoiceNumber">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Invoice #</th>
        <td mat-cell *matCellDef="let row">
          <span class="invoice-number">{{ row.invoiceNumber }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="supplierBillNo">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Supplier Bill #</th>
        <td mat-cell *matCellDef="let row">{{ row.supplierBillNo || '-' }}</td>
      </ng-container>

      <ng-container matColumnDef="supplierName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Supplier</th>
        <td mat-cell *matCellDef="let row">{{ row.supplierId?.name || row.supplierName || '-' }}</td>
      </ng-container>

      <ng-container matColumnDef="invoiceDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
        <td mat-cell *matCellDef="let row">{{ formatDate(row.invoiceDate) }}</td>
      </ng-container>

      <ng-container matColumnDef="totals">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
        <td mat-cell *matCellDef="let row">
          <span class="amount">{{ formatCurrency(row.totals?.grandTotal || 0) }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let row">
          <mat-chip [color]="getStatusColor(row.status)" selected>{{ row.status | titlecase }}</mat-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="paymentStatus">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Payment</th>
        <td mat-cell *matCellDef="let row">
          <mat-chip [color]="getPaymentStatusColor(row.paymentStatus)" selected>{{ row.paymentStatus | titlecase
            }}</mat-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let row">
          <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Actions">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item *ngIf="row.status === 'draft'" (click)="confirmInvoice(row)">
              <mat-icon>check_circle</mat-icon>
              <span>Confirm & Add Stock</span>
            </button>
            <button mat-menu-item *ngIf="row.status === 'confirmed' && row.paymentStatus !== 'paid'"
              (click)="markAsPaid(row)">
              <mat-icon>payment</mat-icon>
              <span>Mark as Paid</span>
            </button>
            <button mat-menu-item *ngIf="row.status !== 'cancelled'" (click)="cancelInvoice(row)">
              <mat-icon>cancel</mat-icon>
              <span>Cancel Invoice</span>
            </button>
            <button mat-menu-item (click)="viewInvoice(row)">
              <mat-icon>visibility</mat-icon>
              <span>View Details</span>
            </button>
            <button mat-menu-item *ngIf="row.status === 'draft'" (click)="editInvoice(row)">
              <mat-icon>edit</mat-icon>
              <span>Edit Invoice</span>
            </button>
            <button mat-menu-item *ngIf="row.status === 'draft'" (click)="deleteInvoice(row)" class="delete-action">
              <mat-icon>delete</mat-icon>
              <span>Delete</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <div class="no-data" *ngIf="dataSource.data.length === 0 && !loading && !error">
      <mat-icon>receipt_long</mat-icon>
      <p>No purchase invoices found</p>
    </div>

    <mat-paginator [length]="totalInvoices" [pageSize]="pageSize" [pageIndex]="pageIndex"
      [pageSizeOptions]="pageSizeOptions" (page)="onPageChange($event)" showFirstLastButtons>
    </mat-paginator>
  </div>
</div>