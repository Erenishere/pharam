<div class="batch-form-container">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>{{ isEditMode ? 'edit' : 'add' }}</mat-icon>
        {{ isEditMode ? 'Edit Batch' : 'Create New Batch' }}
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="batchForm" (ngSubmit)="onSubmit()" class="batch-form">
        
        <!-- Item Selection -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width item-selection-field">
            <mat-label>Item *</mat-label>
            <input
              matInput
              formControlName="itemSearch"
              [matAutocomplete]="itemAuto"
              placeholder="Search for an item..."
              [readonly]="isEditMode">
            <mat-icon matSuffix>search</mat-icon>
            <mat-autocomplete #itemAuto="matAutocomplete" [displayWith]="displayItemFn">
              <mat-option *ngFor="let item of filteredItems$ | async" [value]="item" (onSelectionChange)="onItemSelected(item)">
                <span class="item-code">{{ item.code }}</span> - 
                <span class="item-name">{{ item.name }}</span>
                <small class="item-category">({{ item.category }})</small>
              </mat-option>
            </mat-autocomplete>
            <mat-error *ngIf="batchForm.get('itemSearch')?.hasError('required')">
              Item selection is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Batch Number -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Batch Number *</mat-label>
            <input matInput formControlName="batchNumber" [readonly]="isEditMode">
            <mat-icon matSuffix>qr_code</mat-icon>
            <mat-hint *ngIf="!isEditMode">Format: ITEM-CODE-YYYYMMDD-XXX (auto-generated)</mat-hint>
            <mat-error *ngIf="batchForm.get('batchNumber')?.hasError('required')">
              Batch number is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Quantity and Unit Cost -->
        <div class="form-row two-columns">
          <mat-form-field appearance="outline">
            <mat-label>Quantity *</mat-label>
            <input matInput type="number" formControlName="quantity" min="1">
            <mat-icon matSuffix>inventory</mat-icon>
            <mat-error *ngIf="batchForm.get('quantity')?.hasError('required')">
              Quantity is required
            </mat-error>
            <mat-error *ngIf="batchForm.get('quantity')?.hasError('min')">
              Quantity must be at least 1
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Unit Cost *</mat-label>
            <input matInput type="number" formControlName="unitCost" min="0" step="0.01">
            <span matPrefix>$&nbsp;</span>
            <mat-error *ngIf="batchForm.get('unitCost')?.hasError('required')">
              Unit cost is required
            </mat-error>
            <mat-error *ngIf="batchForm.get('unitCost')?.hasError('min')">
              Unit cost cannot be negative
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Manufacturing and Expiry Dates -->
        <div class="form-row two-columns">
          <mat-form-field appearance="outline">
            <mat-label>Manufacturing Date *</mat-label>
            <input matInput [matDatepicker]="mfgPicker" formControlName="manufacturingDate">
            <mat-datepicker-toggle matSuffix [for]="mfgPicker"></mat-datepicker-toggle>
            <mat-datepicker #mfgPicker></mat-datepicker>
            <mat-error *ngIf="batchForm.get('manufacturingDate')?.hasError('required')">
              Manufacturing date is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Expiry Date *</mat-label>
            <input matInput [matDatepicker]="expPicker" formControlName="expiryDate">
            <mat-datepicker-toggle matSuffix [for]="expPicker"></mat-datepicker-toggle>
            <mat-datepicker #expPicker></mat-datepicker>
            <mat-error *ngIf="batchForm.get('expiryDate')?.hasError('required')">
              Expiry date is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Date validation error -->
        <div class="form-row" *ngIf="hasDateError">
          <mat-error class="date-error">
            Expiry date must be after manufacturing date
          </mat-error>
        </div>

        <!-- Location -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Location *</mat-label>
            <mat-select formControlName="locationId">
              <mat-option *ngFor="let location of locationOptions$ | async" [value]="location.value">
                {{ location.label }} ({{ location.type }})
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>location_on</mat-icon>
            <mat-error *ngIf="batchForm.get('locationId')?.hasError('required')">
              Location is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Supplier (Optional) -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width supplier-selection-field">
            <mat-label>Supplier (Optional)</mat-label>
            <input
              matInput
              formControlName="supplierSearch"
              [matAutocomplete]="supplierAuto"
              placeholder="Search for a supplier...">
            <mat-icon matSuffix>business</mat-icon>
            <mat-autocomplete #supplierAuto="matAutocomplete" [displayWith]="displaySupplierFn">
              <mat-option *ngFor="let supplier of filteredSuppliers$ | async" [value]="supplier" (onSelectionChange)="onSupplierSelected(supplier)">
                <span class="supplier-code">{{ supplier.code }}</span> - 
                <span class="supplier-name">{{ supplier.name }}</span>
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </div>

        <!-- Notes -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width notes-field">
            <mat-label>Notes</mat-label>
            <textarea matInput formControlName="notes" rows="3" placeholder="Additional notes about this batch..."></textarea>
            <mat-icon matSuffix>note</mat-icon>
          </mat-form-field>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button mat-button type="button" (click)="onCancel()" [disabled]="isLoading">
            Cancel
          </button>
          <button 
            mat-raised-button 
            color="primary" 
            type="submit" 
            [disabled]="!isFormValid || isLoading">
            <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
            <mat-icon *ngIf="!isLoading">{{ isEditMode ? 'save' : 'add' }}</mat-icon>
            {{ isEditMode ? 'Update Batch' : 'Create Batch' }}
          </button>
        </div>

      </form>
    </mat-card-content>
  </mat-card>
</div>