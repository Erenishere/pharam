<div class="suppliers-container">
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1 class="page-title">Supplier Management</h1>
            <p class="page-subtitle">Manage your suppliers and customers</p>
        </div>
        <button mat-raised-button color="primary" *ngIf="canCreate" (click)="openCreateDialog()" class="add-button">
            <mat-icon>add</mat-icon>
            Add Supplier
        </button>
    </div>

    <!-- Statistics Section (Admin/Accountant only) -->
    <div class="statistics-section" *ngIf="showStatistics">
        <app-supplier-stats [statistics]="statistics" [loading]="statisticsLoading" [error]="statisticsError"
            (retry)="retryLoadStatistics()">
        </app-supplier-stats>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="d-flex align-items-center">
            <mat-form-field appearance="outline" class="search-field" color="primary">
                <mat-label>Search</mat-label>
                <input matInput [formControl]="searchControl">
                <mat-icon matPrefix>search</mat-icon>
                <button mat-icon-button matSuffix *ngIf="searchControl.value" (click)="clearSearch()"
                    matTooltip="Clear search" type="button">
                    <mat-icon>clear</mat-icon>
                </button>
            </mat-form-field>
        </div>

        <div class="filter-actions d-flex align-items-center gap-2">
            <mat-form-field appearance="outline" class="filter-field" color="primary">
                <mat-label>Filter by Type</mat-label>
                <mat-select [(ngModel)]="selectedType" (selectionChange)="onTypeFilterChange()">
                    <mat-option *ngFor="let type of types" [value]="type.value">
                        {{ type.label }}
                    </mat-option>
                </mat-select>
                <mat-icon matPrefix>category</mat-icon>
            </mat-form-field>

            <div class="inactive-toggle">
                <mat-slide-toggle [(ngModel)]="showInactive" (change)="toggleShowInactive()" color="primary">
                    Show Inactive Only
                </mat-slide-toggle>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-container" *ngIf="loading">
        <mat-spinner diameter="50"></mat-spinner>
        <p class="loading-text">Loading suppliers...</p>
    </div>

    <!-- Error Message with Retry -->
    <div class="error-container" *ngIf="!loading && error">
        <mat-icon class="error-icon">error_outline</mat-icon>
        <p class="error-message">{{ error }}</p>
        <button mat-raised-button color="primary" (click)="retryLoadSuppliers()">
            <mat-icon>refresh</mat-icon>
            Retry
        </button>
    </div>

    <!-- Suppliers Table -->
    <div class="table-container" *ngIf="!loading && !error">
        <table mat-table [dataSource]="dataSource" matSort class="suppliers-table">

            <!-- Code Column -->
            <ng-container matColumnDef="code">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Code</th>
                <td mat-cell *matCellDef="let supplier">
                    <span class="code-badge">{{ supplier.code }}</span>
                </td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
                <td mat-cell *matCellDef="let supplier">
                    <span class="supplier-name">{{ supplier.name }}</span>
                </td>
            </ng-container>

            <!-- Type Column -->
            <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
                <td mat-cell *matCellDef="let supplier">
                    <mat-chip color="primary" selected>
                        {{ supplier.type | titlecase }}
                    </mat-chip>
                </td>
            </ng-container>

            <!-- Phone Column -->
            <ng-container matColumnDef="phone">
                <th mat-header-cell *matHeaderCellDef>Phone</th>
                <td mat-cell *matCellDef="let supplier">
                    <span class="contact-info">
                        {{ supplier.contactInfo?.phone || '-' }}
                    </span>
                </td>
            </ng-container>

            <!-- Email Column -->
            <ng-container matColumnDef="email">
                <th mat-header-cell *matHeaderCellDef>Email</th>
                <td mat-cell *matCellDef="let supplier">
                    <span class="contact-info">
                        {{ supplier.contactInfo?.email || '-' }}
                    </span>
                </td>
            </ng-container>

            <!-- City Column -->
            <ng-container matColumnDef="city">
                <th mat-header-cell *matHeaderCellDef>City</th>
                <td mat-cell *matCellDef="let supplier">
                    <span class="contact-info">
                        {{ supplier.contactInfo?.city || '-' }}
                    </span>
                </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="isActive">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
                <td mat-cell *matCellDef="let supplier">
                    <!-- Toggle for users with permission -->
                    <mat-slide-toggle *ngIf="canToggleStatus" [checked]="supplier.isActive"
                        [disabled]="isActionPending(supplier._id, 'toggle')" (change)="toggleStatus(supplier, $event)"
                        [matTooltip]="supplier.isActive ? 'Click to deactivate' : 'Click to activate'" color="primary">
                        {{ getStatusLabel(supplier.isActive) }}
                    </mat-slide-toggle>

                    <!-- Chip for users without permission -->
                    <mat-chip *ngIf="!canToggleStatus" [color]="getStatusChipColor(supplier.isActive)" selected>
                        {{ getStatusLabel(supplier.isActive) }}
                    </mat-chip>
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let supplier">
                    <div class="action-buttons">
                        <button mat-icon-button (click)="openDetailDialog(supplier)" matTooltip="View Details"
                            color="primary">
                            <mat-icon>visibility</mat-icon>
                        </button>

                        <button mat-icon-button *ngIf="canEdit" (click)="openEditDialog(supplier)" matTooltip="Edit"
                            color="accent">
                            <mat-icon>edit</mat-icon>
                        </button>

                        <button mat-icon-button *ngIf="canDelete && supplier.isActive" (click)="confirmDelete(supplier)"
                            [disabled]="isActionPending(supplier._id, 'delete')" matTooltip="Delete" color="warn">
                            <mat-icon>delete</mat-icon>
                        </button>

                        <button mat-icon-button *ngIf="canRestore && !supplier.isActive"
                            (click)="restoreSupplier(supplier)" [disabled]="isActionPending(supplier._id, 'restore')"
                            matTooltip="Restore" color="primary">
                            <mat-icon>restore</mat-icon>
                        </button>
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>

            <!-- No Data Row -->
            <tr class="mat-row no-data-row" *matNoDataRow>
                <td class="mat-cell" [attr.colspan]="displayedColumns.length">
                    <div class="no-data-message">
                        <mat-icon>inbox</mat-icon>
                        <p>No suppliers found</p>
                        <p class="no-data-hint">Try adjusting your filters or search criteria</p>
                    </div>
                </td>
            </tr>
        </table>

        <!-- Paginator -->
        <mat-paginator [length]="totalSuppliers" [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions"
            [pageIndex]="pageIndex" (page)="onPageChange($event)" showFirstLastButtons>
        </mat-paginator>
    </div>
</div>