<div class="report-container">
  <div class="report-header">
    <div class="header-left">
      <button mat-icon-button class="back-btn" routerLink="/reports"><mat-icon>arrow_back</mat-icon></button>
      <h1>Scheme & Discount Reports</h1>
    </div>
    <div class="header-actions">
      <button mat-stroked-button class="refresh-btn" (click)="loadReport()"><mat-icon>refresh</mat-icon>
        Refresh</button>
    </div>
  </div>

  <div class="filters-card">
    <div class="filters-row">
      <mat-form-field class="filter-field" appearance="outline">
        <mat-label>Start Date</mat-label>
        <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate" placeholder="DD/MM/YYYY">
        <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
        <mat-datepicker #startPicker></mat-datepicker>
      </mat-form-field>
      <mat-form-field class="filter-field" appearance="outline">
        <mat-label>End Date</mat-label>
        <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate" placeholder="DD/MM/YYYY">
        <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
        <mat-datepicker #endPicker></mat-datepicker>
      </mat-form-field>
      <div class="filter-actions">
        <button mat-raised-button color="primary" (click)="applyFilters()">Apply</button>
        <button mat-stroked-button (click)="resetFilters()">Reset</button>
      </div>
    </div>
  </div>

  @if (loading) {
  <div class="loading-container"><mat-spinner diameter="48"></mat-spinner>
    <p>Loading scheme data...</p>
  </div>
  } @else {
  <div class="summary-cards">
    <div class="summary-card">
      <div class="icon-wrapper purple"><mat-icon>local_offer</mat-icon></div>
      <div class="card-content">
        <div class="label">Scheme 1 Qty</div>
        <div class="value">{{ formatNumber(schemeAnalysis?.summary?.totalScheme1Quantity) }}</div>
      </div>
    </div>
    <div class="summary-card">
      <div class="icon-wrapper info"><mat-icon>redeem</mat-icon></div>
      <div class="card-content">
        <div class="label">Scheme 2 Qty</div>
        <div class="value">{{ formatNumber(schemeAnalysis?.summary?.totalScheme2Quantity) }}</div>
      </div>
    </div>
    <div class="summary-card">
      <div class="icon-wrapper success"><mat-icon>attach_money</mat-icon></div>
      <div class="card-content">
        <div class="label">Total Scheme Value</div>
        <div class="value">{{ formatCurrency(schemeAnalysis?.summary?.totalSchemeValue) }}</div>
      </div>
    </div>
    <div class="summary-card">
      <div class="icon-wrapper warning"><mat-icon>discount</mat-icon></div>
      <div class="card-content">
        <div class="label">Discount 1</div>
        <div class="value">{{ formatCurrency(discountBreakdown?.discount1Total) }}</div>
      </div>
    </div>
    <div class="summary-card">
      <div class="icon-wrapper danger"><mat-icon>percent</mat-icon></div>
      <div class="card-content">
        <div class="label">Discount 2</div>
        <div class="value">{{ formatCurrency(discountBreakdown?.discount2Total) }}</div>
      </div>
    </div>
  </div>

  <mat-tab-group [(selectedIndex)]="activeTab" class="report-tabs">
    <mat-tab label="Scheme Analysis">
      <div class="data-card">
        <div class="card-header">
          <h2>Scheme Analysis by Item</h2>
        </div>
        <div class="table-container">
          @if (schemeAnalysis?.schemes?.length > 0) {
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th class="text-right">Scheme 1 Qty</th>
                <th class="text-right">Scheme 2 Qty</th>
                <th class="text-right">Total Value</th>
              </tr>
            </thead>
            <tbody>
              @for (row of schemeAnalysis.schemes; track row.item?._id) {
              <tr>
                <td>{{ row.item?.name || 'Unknown' }}</td>
                <td class="text-right">{{ formatNumber(row.scheme1Qty) }}</td>
                <td class="text-right">{{ formatNumber(row.scheme2Qty) }}</td>
                <td class="text-right amount">{{ formatCurrency(row.totalValue) }}</td>
              </tr>
              }
            </tbody>
          </table>
          } @else {
          <div class="empty-state"><mat-icon>inbox</mat-icon>
            <p>No scheme data available</p>
          </div>
          }
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Discount Breakdown">
      <div class="data-card">
        <div class="card-header">
          <h2>Discount Breakdown by Claim Account</h2>
        </div>
        <div class="table-container">
          @if (discountBreakdown?.byClaimAccount?.length > 0) {
          <table>
            <thead>
              <tr>
                <th>Claim Account</th>
                <th class="text-right">Discount 1</th>
                <th class="text-right">Discount 2</th>
                <th class="text-right">Total</th>
              </tr>
            </thead>
            <tbody>
              @for (row of discountBreakdown.byClaimAccount; track row.account) {
              <tr>
                <td>{{ row.account || 'Unknown' }}</td>
                <td class="text-right">{{ formatCurrency(row.discount1) }}</td>
                <td class="text-right">{{ formatCurrency(row.discount2) }}</td>
                <td class="text-right amount">{{ formatCurrency((row.discount1 || 0) + (row.discount2 || 0)) }}</td>
              </tr>
              }
            </tbody>
          </table>
          } @else {
          <div class="empty-state"><mat-icon>inbox</mat-icon>
            <p>No discount data available</p>
          </div>
          }
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
  }
</div>