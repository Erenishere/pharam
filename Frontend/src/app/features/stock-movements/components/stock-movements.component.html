<div class="stock-movements-container">
  <div class="page-header">
    <div class="header-left">
      <h1>Stock Movements</h1>
      <p class="subtitle">Track inventory changes and stock adjustments</p>
    </div>
    <button mat-raised-button color="primary" (click)="openAdjustmentForm()">
      <mat-icon>add</mat-icon> Stock Adjustment
    </button>
  </div>

  <div class="summary-cards">
    <mat-card class="summary-card stock-in">
      <mat-card-content>
        <mat-icon>arrow_downward</mat-icon>
        <div class="card-info">
          <span class="label">Total Stock In</span>
          <span class="value">{{ formatNumber(statistics.totalIn) }}</span>
        </div>
      </mat-card-content>
    </mat-card>
    <mat-card class="summary-card stock-out">
      <mat-card-content>
        <mat-icon>arrow_upward</mat-icon>
        <div class="card-info">
          <span class="label">Total Stock Out</span>
          <span class="value">{{ formatNumber(statistics.totalOut) }}</span>
        </div>
      </mat-card-content>
    </mat-card>
    <mat-card class="summary-card adjustments">
      <mat-card-content>
        <mat-icon>swap_vert</mat-icon>
        <div class="card-info">
          <span class="label">Adjustments</span>
          <span class="value">{{ formatNumber(statistics.totalAdjustments) }}</span>
        </div>
      </mat-card-content>
    </mat-card>
    <mat-card class="summary-card net-change" [class.positive]="statistics.netChange >= 0" [class.negative]="statistics.netChange < 0">
      <mat-card-content>
        <mat-icon>{{ statistics.netChange >= 0 ? 'trending_up' : 'trending_down' }}</mat-icon>
        <div class="card-info">
          <span class="label">Net Change</span>
          <span class="value">{{ statistics.netChange >= 0 ? '+' : '' }}{{ formatNumber(statistics.netChange) }}</span>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="filters-section">
    <mat-form-field appearance="outline">
      <mat-label>From Date</mat-label>
      <input matInput [matDatepicker]="fromPicker" [(ngModel)]="dateFrom" (dateChange)="onFilterChange()">
      <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
      <mat-datepicker #fromPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>To Date</mat-label>
      <input matInput [matDatepicker]="toPicker" [(ngModel)]="dateTo" (dateChange)="onFilterChange()">
      <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
      <mat-datepicker #toPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Movement Type</mat-label>
      <mat-select [(value)]="selectedMovementType" (selectionChange)="onFilterChange()">
        <mat-option *ngFor="let opt of movementTypes" [value]="opt.value">{{ opt.label }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Reference Type</mat-label>
      <mat-select [(value)]="selectedReferenceType" (selectionChange)="onFilterChange()">
        <mat-option *ngFor="let opt of referenceTypes" [value]="opt.value">{{ opt.label }}</mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-stroked-button color="warn" (click)="clearFilters()" 
            *ngIf="dateFrom || dateTo || selectedMovementType || selectedReferenceType">
      <mat-icon>clear</mat-icon> Clear
    </button>
  </div>

  <div class="form-panel" *ngIf="showAdjustmentForm">
    <h4>Stock Adjustment</h4>
    <form [formGroup]="adjustmentForm" class="entry-form">
      <div class="form-row">
        <mat-form-field>
          <mat-label>Item</mat-label>
          <mat-select formControlName="itemId">
            <mat-option *ngFor="let item of items" [value]="item._id">
              {{ item.code }} - {{ item.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Adjustment Type</mat-label>
          <mat-select formControlName="adjustmentType">
            <mat-option value="adjustment">Quantity Adjustment (+/-)</mat-option>
            <mat-option value="correction">Physical Count Correction</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field *ngIf="adjustmentForm.get('adjustmentType')?.value === 'adjustment'">
          <mat-label>Quantity (+/-)</mat-label>
          <input matInput type="number" formControlName="quantity">
          <mat-hint>Positive to add, negative to remove</mat-hint>
        </mat-form-field>

        <mat-form-field *ngIf="adjustmentForm.get('adjustmentType')?.value === 'correction'">
          <mat-label>Actual Physical Stock</mat-label>
          <input matInput type="number" formControlName="actualStock">
          <mat-hint>Enter the actual count from physical inventory</mat-hint>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Reason</mat-label>
          <input matInput formControlName="reason" placeholder="e.g., Damaged goods, Physical count correction">
        </mat-form-field>
      </div>

      <div class="form-actions">
        <button mat-button (click)="cancelForm()">Cancel</button>
        <button mat-raised-button color="primary" (click)="saveAdjustment()">
          Record Adjustment
        </button>
      </div>
    </form>
  </div>

  <mat-tab-group [(selectedIndex)]="activeTab">
    <mat-tab label="Movement History">
      <div class="tab-content">
        <div class="loading-overlay" *ngIf="loading">
          <mat-spinner diameter="40"></mat-spinner>
        </div>

        <table mat-table [dataSource]="movementsDataSource" class="data-table">
          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>Date/Time</th>
            <td mat-cell *matCellDef="let row">{{ formatDate(row.createdAt) }}</td>
          </ng-container>

          <ng-container matColumnDef="itemName">
            <th mat-header-cell *matHeaderCellDef>Item</th>
            <td mat-cell *matCellDef="let row">
              <div class="item-info">
                <span class="item-code">{{ row.itemId?.code || row.itemCode }}</span>
                <span class="item-name">{{ row.itemId?.name || row.itemName || '-' }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="movementType">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let row">
              <mat-chip [color]="getMovementTypeColor(row.movementType)" selected>
                <mat-icon class="type-icon">{{ getMovementTypeIcon(row.movementType) }}</mat-icon>
                {{ row.movementType | titlecase }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="referenceType">
            <th mat-header-cell *matHeaderCellDef>Reference</th>
            <td mat-cell *matCellDef="let row">
              {{ row.referenceType | titlecase }}
              <span class="ref-number" *ngIf="row.referenceNumber">#{{ row.referenceNumber }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef>Qty</th>
            <td mat-cell *matCellDef="let row" [class.positive]="row.quantity > 0" [class.negative]="row.quantity < 0">
              {{ row.quantity > 0 ? '+' : '' }}{{ formatNumber(row.quantity) }}
            </td>
          </ng-container>

          <ng-container matColumnDef="previousStock">
            <th mat-header-cell *matHeaderCellDef>Before</th>
            <td mat-cell *matCellDef="let row">{{ formatNumber(row.previousStock) }}</td>
          </ng-container>

          <ng-container matColumnDef="newStock">
            <th mat-header-cell *matHeaderCellDef>After</th>
            <td mat-cell *matCellDef="let row">
              <strong>{{ formatNumber(row.newStock) }}</strong>
            </td>
          </ng-container>

          <ng-container matColumnDef="reason">
            <th mat-header-cell *matHeaderCellDef>Reason</th>
            <td mat-cell *matCellDef="let row">{{ row.reason || '-' }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="movementColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: movementColumns;"></tr>
        </table>

        <div class="no-data" *ngIf="movementsDataSource.data.length === 0 && !loading">
          <mat-icon>inventory_2</mat-icon>
          <p>No stock movements found</p>
        </div>

        <mat-paginator
          [length]="totalMovements"
          [pageSize]="pageSize"
          [pageIndex]="pageIndex"
          [pageSizeOptions]="[10, 25, 50, 100]"
          (page)="onPageChange($event)">
        </mat-paginator>
      </div>
    </mat-tab>

    <mat-tab label="Low Stock Alerts">
      <div class="tab-content">
        <table mat-table [dataSource]="lowStockDataSource" class="data-table">
          <ng-container matColumnDef="code">
            <th mat-header-cell *matHeaderCellDef>Code</th>
            <td mat-cell *matCellDef="let row">{{ row.code }}</td>
          </ng-container>

          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Item Name</th>
            <td mat-cell *matCellDef="let row">{{ row.name }}</td>
          </ng-container>

          <ng-container matColumnDef="currentStock">
            <th mat-header-cell *matHeaderCellDef>Current Stock</th>
            <td mat-cell *matCellDef="let row" class="warn-text">
              <strong>{{ formatNumber(row.currentStock) }}</strong>
            </td>
          </ng-container>

          <ng-container matColumnDef="minimumStock">
            <th mat-header-cell *matHeaderCellDef>Min Stock</th>
            <td mat-cell *matCellDef="let row">{{ formatNumber(row.minimumStock) }}</td>
          </ng-container>

          <ng-container matColumnDef="daysUntilStockout">
            <th mat-header-cell *matHeaderCellDef>Days Until Stockout</th>
            <td mat-cell *matCellDef="let row">
              <mat-chip color="warn" selected *ngIf="row.daysUntilStockout <= 7">
                {{ row.daysUntilStockout }} days
              </mat-chip>
              <span *ngIf="row.daysUntilStockout > 7">{{ row.daysUntilStockout }} days</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let row">
              <button mat-stroked-button color="primary" matTooltip="Create Purchase Order">
                <mat-icon>shopping_cart</mat-icon> Reorder
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="lowStockColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: lowStockColumns;"></tr>
        </table>

        <div class="no-data" *ngIf="lowStockDataSource.data.length === 0">
          <mat-icon>check_circle</mat-icon>
          <p>All items are well stocked!</p>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
